<script>
    const API = 'https://script.google.com/macros/s/AKfycbwvd5_eqEp-FIcv8FbfatNRohOIHoTunIUZVxNhYh9ZeHBMMB1pWcLCNhxO9S5hqiUU/exec';
    let user = localStorage.getItem('podium_user');
    let app = { region: '', nivel: '', p1: '', p2: '', p3: '', ediciones: 0, existe: false };
    let cacheData = {};

    if (user) { initApp(); }

    function toggleLoader(s) { document.getElementById('loading-overlay').classList.toggle('hidden', !s); }

    function initApp() {
        document.getElementById('header-username').innerText = user;
        document.getElementById('global-header').classList.remove('hidden');
        showView('view-region');
        renderRegiones();
    }

    function showView(id) {
        document.querySelectorAll('div[id^="view-"]').forEach(v => v.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
        const cont = document.getElementById('atras-container');
        if(id === 'view-region') cont.classList.add('invisible');
        else {
            cont.classList.remove('invisible');
            document.getElementById('btn-atras').onclick = () => showView(id === 'view-dashboard' ? 'view-region' : 'view-dashboard');
        }
    }

    function renderRegiones() {
        const rs = ['NORTE', 'ORIENTE', 'CENTRO-SUR', 'OCCIDENTE PRÓSPERO', 'MAGDALENA CALDENSE', 'ALTO OCCIDENTE'];
        const c = document.getElementById('region-list'); c.innerHTML = '';
        rs.forEach(r => {
            const b = document.createElement('button');
            b.className = 'premium-card p-6 font-black uppercase text-lg text-center';
            b.innerText = r; b.onclick = () => cargarDatosRegion(r);
            c.appendChild(b);
        });
    }

    async function cargarDatosRegion(region) {
        app.region = region;
        document.getElementById('dash-region-tag').innerText = region;
        showView('view-dashboard');
        toggleLoader(true);
        const niveles = ['basico', 'medio', 'alto'];
        try {
            const promesas = niveles.map(n => fetch(API, { method: 'POST', body: JSON.stringify({ action: 'getData', user, region, nivel: n }) }).then(r => r.json()));
            const resultados = await Promise.all(promesas);
            niveles.forEach((n, i) => {
                const d = resultados[i]; cacheData[n] = d;
                document.getElementById(`pozo-${n}-label`).innerText = `$${(d.config?.pozo || 0).toLocaleString()}`;
                const btnBox = document.getElementById(`btns-${n}`);
                if(d.miApuesta) btnBox.classList.remove('hidden'); else btnBox.classList.add('hidden');
            });
        } catch(e) { alert('ERROR'); }
        toggleLoader(false);
    }

    function confirmarModificar(nivelLabel) {
        document.getElementById('modal-title').innerText = "ATENCIÓN";
        document.getElementById('modal-text').innerText = "Vas a editar tu apuesta.\n\nEste proceso tiene un costo de $1.000 que se descontará del pozo.";
        document.getElementById('btn-modal-ok').innerText = "ENTENDIDO";
        document.getElementById('btn-modal-ok').onclick = () => { closeModal(); abrirNivel(nivelLabel); };
        document.getElementById('modal-confirm').classList.remove('hidden');
    }

    function abrirNivel(nivelLabel) {
        app.nivel = nivelLabel;
        const nNorm = nivelLabel.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        const d = cacheData[nNorm];
        app.p1 = app.p2 = app.p3 = '';
        document.getElementById('podium-header').innerText = nivelLabel.toUpperCase();
        if(d.miApuesta) {
            app.p1 = d.miApuesta.p1; app.p2 = d.miApuesta.p2; app.p3 = d.miApuesta.p3;
            app.ediciones = d.miApuesta.ediciones; app.existe = true;
        } else { app.existe = false; }
        renderBandas(d.bandas, nNorm);
        syncUI();
        showView('view-podium');
    }

    function renderBandas(bandas, nNorm) {
        const c = document.getElementById('band-container'); c.innerHTML = '';
        const f = bandas.filter(b => b.region.trim().toLowerCase() === app.region.trim().toLowerCase() && b.nivel.trim().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "") === nNorm);
        f.forEach(b => {
            const bt = document.createElement('button');
            bt.className = 'premium-card p-5 text-[11px] font-black uppercase leading-tight';
            bt.innerText = b.nombre; 
            bt.onclick = () => {
                if(!app.p1) app.p1 = b.nombre; 
                else if(!app.p2 && b.nombre !== app.p1) app.p2 = b.nombre; 
                else if(!app.p3 && b.nombre !== app.p1 && b.nombre !== app.p2) app.p3 = b.nombre;
                syncUI();
            }; 
            c.appendChild(bt);
        });
    }

    function syncUI() {
        document.getElementById('txt-p1').innerText = app.p1 || 'VACÍO';
        document.getElementById('txt-p2').innerText = app.p2 || 'VACÍO';
        document.getElementById('txt-p3').innerText = app.p3 || 'VACÍO';
        
        const picks = [app.p1, app.p2, app.p3].filter(p => p !== '');
        
        // Opacar y desactivar bandas ya seleccionadas
        document.querySelectorAll('#band-container button').forEach(btn => {
            if(picks.includes(btn.innerText)) {
                btn.classList.add('band-disabled');
                btn.style.opacity = "0.2";
                btn.style.pointerEvents = "none";
            } else {
                btn.classList.remove('band-disabled');
                btn.style.opacity = "1";
                btn.style.pointerEvents = "auto";
            }
        });

        for(let i=1; i<=3; i++) {
            document.getElementById(`slot-${i}`).className = `podium-slot flex-col p-2 text-center ${app['p'+i] ? 'slot-filled' : ''}`;
        }
    }

    async function verEstadisticas(n) {
        toggleLoader(true);
        try {
            const r = await fetch(API, { method: 'POST', body: JSON.stringify({ action: 'getStats', region: app.region, nivel: n }) });
            const d = await r.json();
            let txt = d.stats.length > 0 ? d.stats.map(s => `- ${s.nombre}`).join('\n') : "- SIN DATOS -";
            document.getElementById('modal-title').innerText = "ESTADÍSTICAS";
            document.getElementById('modal-text').innerText = "LAS DOS BANDAS MÁS SELECCIONADAS:\n" + txt;
            document.getElementById('btn-modal-ok').innerText = "CERRAR";
            document.getElementById('btn-modal-ok').onclick = closeModal;
            document.getElementById('btn-modal-cancel').classList.add('hidden');
            document.getElementById('modal-confirm').classList.remove('hidden');
        } catch(e) { alert('ERROR'); }
        toggleLoader(false);
    }

    function closeModal() { 
        document.getElementById('modal-confirm').classList.add('hidden'); 
        document.getElementById('btn-modal-cancel').classList.remove('hidden');
    }

    function prepararConfirmacion() {
        if(!app.p1 || !app.p2 || !app.p3) return alert('COMPLETA EL PÓDIUM');
        document.getElementById('modal-title').innerText = "¿CONFIRMAR?";
        document.getElementById('modal-text').innerText = app.existe ? `MODIFICAR COSTARÁ $1.000.\nINTENTOS REALIZADOS: ${app.ediciones}` : `ESTA APUESTA TIENE UN VALOR DE $20.000.`;
        document.getElementById('btn-modal-ok').innerText = "SÍ, ENVIAR";
        document.getElementById('btn-modal-ok').onclick = execSave;
        document.getElementById('modal-confirm').classList.remove('hidden');
    }

    async function execSave() {
        closeModal(); toggleLoader(true);
        try {
            const nNorm = app.nivel.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
            await fetch(API, { method: 'POST', body: JSON.stringify({ action: 'saveApuesta', user, region: app.region, categoria: nNorm, p1: app.p1, p2: app.p2, p3: app.p3 }) });
            alert('¡ÉXITO!'); await cargarDatosRegion(app.region); 
        } catch(e) { alert('ERROR'); }
        toggleLoader(false);
    }

    function removeBand(s) { app['p'+s] = ''; syncUI(); }
    function logout() { localStorage.clear(); location.reload(); }
    
    async function handleLogin() {
        const u = document.getElementById('login-user').value.trim();
        const p = document.getElementById('login-pass').value.trim();
        if(!u || !p) return;
        toggleLoader(true);
        try {
            const r = await fetch(API, { method: 'POST', body: JSON.stringify({ action: 'login', user: u, pass: p }) });
            const d = await r.json();
            if(d.success) { user = u; localStorage.setItem('podium_user', u); initApp(); } else alert('ERROR');
        } catch(e) { alert('ERROR'); }
        toggleLoader(false);
    }
</script>
